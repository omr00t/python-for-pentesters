#!/bin/bash

if [[ "--clean" == $@ ]]; then
	echo "Cleaning up.."
	echo "Deleting webapp rule.."
	sudo iptables -D INPUT -s 172.16.238.100 -d 172.16.238.1 -j ACCEPT &> /dev/null
	# Handle duplicate rules.
	while [ $? -eq 0 ]; do 
		sudo iptables -D INPUT -s 172.16.238.100 -d 172.16.238.1 -j ACCEPT &> /dev/null
	done

	echo "Deleting subnet rule.."
	sudo iptables -D INPUT -s 172.16.238.0/24 -d 172.16.238.1 -j DROP 2>&1 &> /dev/null
	# Handle duplicate rules.
	while [ $? -eq 0 ]; do 
		sudo iptables -D INPUT -s 172.16.238.0/24 -d 172.16.238.1 -j DROP &> /dev/null
	done
	# Stopping docker-compose
	docker-compose down -v
else
	echo "Setting up.."
	echo "Inserting subnet rule.."
	# Deny packets from containers to host
	sudo iptables -I INPUT -s 172.16.238.0/24 -d 172.16.238.1 -j DROP
	echo "Inserting webapp rule.."
	# Allow packets from webapp to host
	sudo iptables -I INPUT -s 172.16.238.100 -d 172.16.238.1 -j ACCEPT
	# Build containers
	docker-compose build
	# Launching docker-compose
	docker-compose up
fi
